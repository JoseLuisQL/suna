version: "3.8"

services:
  redis:
    image: redis:7-alpine
    expose:
      - 6379
    volumes:
      - redis_data:/data
    command: redis-server --save 60 1 --loglevel warning
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - dokploy-network

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    expose:
      - 8000
    environment:
      # === CORE ===
      - ENV_MODE=production
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
      - REDIS_SSL=false
      # === SUPABASE ===
      - SUPABASE_URL=https://zprpzciseqmrfayrzzcf.supabase.co
      - SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwcnB6Y2lzZXFtcmZheXJ6emNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MDYyNTksImV4cCI6MjA4Mzk4MjI1OX0.FgCFeZkx8GrNTEI4mpEhB_-ELhDS3fNQLHHZ0tLydZ0
      - SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwcnB6Y2lzZXFtcmZheXJ6emNmIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODQwNjI1OSwiZXhwIjoyMDgzOTgyMjU5fQ.EdkPegSYo1J-NbS6zfDszgILQcl1Q-GmCw3HWCYV-yA
      - SUPABASE_JWT_SECRET=${SUPABASE_JWT_SECRET}
      - DATABASE_URL=postgresql://postgres.zprpzciseqmrfayrzzcf:luisdkb789JLQL@aws-1-us-east-1.pooler.supabase.com:6543/postgres
      # === DAYTONA ===
      - DAYTONA_API_KEY=${DAYTONA_API_KEY}
      - DAYTONA_SERVER_URL=https://app.daytona.io/api
      - DAYTONA_TARGET=us
      # === COMPOSIO ===
      - COMPOSIO_API_KEY=${COMPOSIO_API_KEY}
      # === LLM PROVIDERS ===
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - MORPH_API_KEY=${MORPH_API_KEY}
      # === AWS BEDROCK ===
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION_NAME=${AWS_REGION_NAME}
      - AWS_BEARER_TOKEN_BEDROCK=${AWS_BEARER_TOKEN_BEDROCK}
      # === SEARCH APIS ===
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - FIRECRAWL_API_KEY=${FIRECRAWL_API_KEY}
      - FIRECRAWL_URL=https://api.firecrawl.dev
      - EXA_API_KEY=${EXA_API_KEY}
      - SERPER_API_KEY=${SERPER_API_KEY}
      - RAPID_API_KEY=${RAPID_API_KEY}
      # === WEBHOOKS & SECURITY ===
      - WEBHOOK_BASE_URL=https://api.kortix.qware.me
      - NEXT_PUBLIC_URL=https://kortix.qware.me
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - MCP_CREDENTIAL_ENCRYPTION_KEY=${MCP_CREDENTIAL_ENCRYPTION_KEY}
      - KORTIX_ADMIN_API_KEY=${KORTIX_ADMIN_API_KEY}
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.suna-backend.rule=Host(`api.kortix.qware.me`)"
      - "traefik.http.routers.suna-backend.entrypoints=websecure"
      - "traefik.http.routers.suna-backend.tls.certResolver=letsencrypt"
      - "traefik.http.services.suna-backend.loadbalancer.server.port=8000"

  frontend:
    build:
      context: .
      dockerfile: apps/frontend/Dockerfile
      args:
        NEXT_PUBLIC_BACKEND_URL: https://api.kortix.qware.me/v1
        NEXT_PUBLIC_URL: https://kortix.qware.me
        NEXT_PUBLIC_ENV_MODE: production
        NEXT_PUBLIC_SUPABASE_URL: https://zprpzciseqmrfayrzzcf.supabase.co
        NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwcnB6Y2lzZXFtcmZheXJ6emNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MDYyNTksImV4cCI6MjA4Mzk4MjI1OX0.FgCFeZkx8GrNTEI4mpEhB_-ELhDS3fNQLHHZ0tLydZ0
        PNPM_LOCKFILE_MODE: --frozen-lockfile
    expose:
      - 3000
    depends_on:
      - backend
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.suna-frontend.rule=Host(`kortix.qware.me`)"
      - "traefik.http.routers.suna-frontend.entrypoints=websecure"
      - "traefik.http.routers.suna-frontend.tls.certResolver=letsencrypt"
      - "traefik.http.services.suna-frontend.loadbalancer.server.port=3000"

volumes:
  redis_data:

networks:
  dokploy-network:
    external: true
